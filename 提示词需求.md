# Google 流量任务系统（Go）- Claude 提示词需求

## 1. 你的角色
你是资深 Go 后端架构师 + 全栈工程师，请从 0 到 1 生成一个可运行的项目：
- 语言：Go
- 架构：主控（Master）+ 多下载节点（Agent）
- 管理方式：Web 控制台可新增/管理节点、下发任务、监控任务
- 目标：按主控下发的参数，稳定执行 Google 相关下载流量任务（YouTube 视频流、Google 静态资源）

## 2. 核心目标
实现一个“可控流量任务平台”：
1. 主控可管理多个 Agent 节点
2. 主控可创建下载任务并分配给指定节点
3. 每个任务可指定目标速率（例如 10 Mbps）
4. Agent 必须按目标速率执行，误差可观测并可调
5. Web 页面可实时查看节点状态、任务状态、实际速率
6. 主控可精确控制任务下发时间、执行总量与节奏，使流量符合预设的“自然访问曲线”
7. 可在 Web 输入 Agent 的 IP/SSH 端口/认证方式后，由 Master 自动完成 Agent 安装与注册

## 3. 功能范围

### 3.1 Master（主控）
- 节点管理：
  - 节点注册（首次接入）
  - 心跳保活（在线/离线判断）
  - 节点标签（地区、运营商、用途）
  - 节点纳管：在 Web 手动录入 `ip + ssh_port + auth`，触发远程自动部署 Agent
  - 节点初始化：自动下发二进制、写入配置、创建 systemd 服务、启动并回连 Master
- 任务管理：
  - 创建任务：任务类型、URL/资源标识、目标速率 Mbps、持续时长、并发数、重试策略、目标节点
  - 时间控制：支持 `start_at`、`end_at`（或 `duration_sec`）、时区、工作日/周末策略
  - 总量控制：支持 `total_bytes_target`、`total_requests_target`、节点级配额
  - 自然流量画像：支持 `flat`、`ramp`、`diurnal`（日内波动曲线）和抖动参数
  - 下发节流：支持 `dispatch_rate_tpm`（每分钟下发任务数）与 `dispatch_batch_size`
  - 下发任务：通过 API 推送或 Agent 拉取
  - 停止任务：支持手动中止
- 监控与统计：
  - 任务维度：目标速率、实时速率、累计流量、成功率、错误码
  - 调度维度：计划开始/结束时间、计划总量、实际总量、时间偏差、总量偏差
  - 节点维度：在线状态、CPU/内存、带宽使用
  - 聚合维度：所有在线 Agent 实时总带宽（Mbps）
- Web 控制台：
  - 节点列表页、任务列表页、任务创建页、任务详情页
  - Dashboard：全局实时总带宽卡片 + 各 Agent 实时带宽 + 7 天历史速度曲线
  - 流量画像配置页（模板管理）
  - 节点接入向导页（IP、SSH 端口、用户名、认证方式、连通性测试、部署日志）

### 3.2 Agent（下载节点）
- 与 Master 通信：
  - 注册 + 心跳
  - 拉取任务或接收任务
  - 上报执行指标
- 下载执行器：
  - 任务类型 A：YouTube 视频流量任务（基于可访问的视频 URL，使用 `yt-dlp` 执行）
  - 任务类型 B：Google 静态资源(android studio 安装包之类的)
  - 所有的下载任务要能在web上添加或者删除
- 限速控制：
  - 单任务限速（例如 10 Mbps）
  - 支持突发控制和稳定收敛
  - 建议实现：Token Bucket + 分片下载 + 定时反馈控制
  - 支持节奏控制：请求间隔抖动（jitter）、分时段速率系数、爬升/回落曲线

### 3.4 YouTube 下载实现（yt-dlp）
- 依赖：
  - Agent 节点需安装 `yt-dlp`（可由 Master 自动纳管时一并安装）
- 命令映射建议：
  - `target_rate_mbps=10` -> `yt-dlp --limit-rate 10M <url>`
  - 并发片段：`--concurrent-fragments <n>`（用于调整吞吐稳定性）
  - 重试：`--retries <n>`
  - 输出目录与文件名模板由任务参数控制
- 执行策略：
  - Agent 以子进程方式运行 `yt-dlp`，实时采集 stdout/stderr 和下载统计
  - 将 `yt-dlp` 实际下载速率换算为 Mbps 上报给 Master
  - 当任务被停止时，优雅终止 `yt-dlp` 子进程

### 3.3 Agent 自动配置流程（新增）
- 输入参数：
  - `host_ip`, `ssh_port`, `ssh_user`, `auth_type(key/password)`, `credential_ref`
- Master 执行步骤：
  1. SSH 连通性校验
  2. 上传 agent 二进制与配置文件
  3. 创建/更新 systemd 服务
  4. 启动服务并健康检查
  5. 标记节点为 `online` 并写入标签
- 失败处理：
  - 记录失败步骤与 stderr
  - 支持重试与回滚（删除半成品服务文件）

## 4. 关键技术要求
1. Go 版本：1.22+
2. 代码结构清晰，至少分为：
   - `cmd/master`
   - `cmd/agent`
   - `internal/master`
   - `internal/agent`
   - `pkg/ratelimit`
   - `web`（前端资源）
3. API 协议：REST JSON（可选补充 gRPC）
4. 存储：SQLite（开发）+ 可扩展 PostgreSQL
5. 并发：基于 goroutine + context 控制生命周期
6. 可观测性：结构化日志 + Prometheus 指标 + 健康检查
7. YouTube 任务必须通过 `yt-dlp` 实现，不自行解析 YouTube 协议
8. 带宽历史数据落盘 SQLite，保留最近 7 天

## 5. 速率控制验收标准（重点）
- 任务参数示例：`target_rate_mbps=10`
- 验收口径：
  - 5 秒窗口平均速率误差不超过 ±10%
  - 30 秒窗口平均速率误差不超过 ±5%
- 任务详情页可显示：
  - 目标速率
  - 当前速率
  - 窗口均值
  - 偏差百分比

## 6.1 Dashboard 与历史速度验收标准（新增重点）
- Dashboard 必须展示：
  - 所有在线 Agent 实时总带宽（每秒刷新）
  - 每个 Agent 当前带宽
  - 最近 7 天历史速度曲线（支持 1m/5m 聚合）
- 存储要求：
  - 指标写入本地 SQLite 表（例如 `bandwidth_samples`）
  - 仅保留 7 天数据，超过自动清理
  - 清理任务建议每小时执行一次（定时 purge）
- 验收口径：
  - 实时总带宽 = 在线 Agent 带宽求和，误差 <= ±2%
  - 查询最近 7 天数据响应可用，且无 7 天前数据残留

## 6. 时间与总量控制验收标准（新增重点）
- 任务参数示例：
  - `start_at=2026-02-27T09:00:00+08:00`
  - `end_at=2026-02-27T10:00:00+08:00`
  - `total_bytes_target=4_500_000_000`
  - `distribution=diurnal`
  - `jitter_pct=0.15`
- 验收口径：
  - 开始时间偏差 <= 2 秒
  - 结束时间偏差 <= 2 秒（正常停止场景）
  - 任务结束时总量误差 <= ±3%
  - 1 分钟窗口内速率曲线与模板方向一致（升/降趋势正确）
  - 相邻请求间隔有随机性，不允许固定周期“机械节奏”
  - 下发节奏符合 `dispatch_rate_tpm`，无突发尖峰
- 任务详情页可显示：
  - 计划开始/结束时间
  - 计划总量与实际总量
  - 当前阶段（ramp-up / steady / ramp-down）
  - 曲线匹配度（计划 vs 实际）

## 7. API 草案（至少实现）

### Master API
- `POST /api/v1/agents/register`
- `POST /api/v1/agents/heartbeat`
- `GET /api/v1/agents`
- `POST /api/v1/tasks`
- `POST /api/v1/tasks/{id}/dispatch`
- `POST /api/v1/tasks/{id}/stop`
- `GET /api/v1/tasks`
- `GET /api/v1/tasks/{id}`
- `POST /api/v1/tasks/{id}/metrics`
- `POST /api/v1/traffic-profiles`
- `GET /api/v1/traffic-profiles`
- `POST /api/v1/tasks/{id}/schedule`
- `POST /api/v1/agents/provision`
- `GET /api/v1/agents/provision-jobs`
- `GET /api/v1/agents/provision-jobs/{job_id}`
- `POST /api/v1/tasks/{id}/run`（可选，手动触发执行）
- `GET /api/v1/dashboard/overview`（实时总带宽、在线节点数、运行任务数）
- `GET /api/v1/dashboard/bandwidth/history?from=&to=&step=1m`

### Agent 行为
- 周期拉取：`GET /api/v1/agents/{agent_id}/tasks/pull`
- 上报执行状态：`POST /api/v1/tasks/{id}/metrics`

## 8. 数据模型建议
- Agent
  - id, name, status, tags, last_heartbeat_at, created_at
- Task
  - id, type(youtube/static), source, target_rate_mbps, duration_sec, concurrency, status, created_at, started_at, ended_at
  - start_at, end_at, total_bytes_target, total_requests_target, profile_id, jitter_pct, ramp_up_sec, ramp_down_sec
  - youtube_format, ytdlp_args_json
  - dispatch_rate_tpm, dispatch_batch_size
- TaskExecution
  - id, task_id, agent_id, current_rate_mbps, avg_rate_5s, avg_rate_30s, bytes_total, error_count, updated_at
  - planned_rate_mbps, schedule_drift_ms, volume_progress_pct, phase
- BandwidthSample
  - id, ts, agent_id, rate_mbps, source(task/heartbeat), created_at
- TrafficProfile
  - id, name, distribution(flat/ramp/diurnal), hourly_weights_json, jitter_pct, burst_factor, created_at
- AgentProvisionJob
  - id, host_ip, ssh_port, ssh_user, auth_type, status, step, log, error_msg, started_at, ended_at

## 9. 安全与边界
- 仅对已授权测试目标发起流量
- URL 域名白名单（例如 `*.googlevideo.com`, `*.gstatic.com`, `*.googleapis.com`）
- Agent 与 Master 使用 token 鉴权（后续可升级 mTLS）
- 所有敏感配置通过环境变量加载
- SSH 私钥不明文落库，使用 `credential_ref` 引用密钥管理存储
- 限制可纳管网段与登录用户白名单，避免误操作

## 10. 交付要求
请按以下顺序交付：
1. 初始化项目目录与 `go.mod`
2. 完成 Master 基础 API + SQLite 持久化
3. 完成 Agent 自动纳管（SSH 部署 + systemd 拉起）
4. 完成 Agent 注册/心跳/拉取任务/上报指标
5. 完成下载执行器与限速器
6. 完成基础 Web 控制台（可先服务端模板）
7. 提供 Docker Compose 一键启动
8. 提供 README（启动方式、API 示例、限速验证方法）

